{% extends 'base.html' %}
{% set title = _('Spam Moderators Dashboard') %}

{% block title %}{{ page_title(title) }}{% endblock %}

{% block content %}

    <div class="dashboard">
        <h1>{{ title }}</h1>
        <h2>{{ _('Summary') }}</h2>
          {% if summary.total %}
            <p>
                {{ ngettext('Yesterday there were:',
                            'Over the past %(num)s days, there were:',
                            summary.days) }}
                <ul>
                    <li>
                        {{- ngettext('%(num)s attempted change',
                                     '%(num)s attempted changes',
                                     summary.total) -}}
                    </li>
                    <li>
                        {{- ngettext('%(num)s good contribution',
                                     '%(num)s good contributions',
                                     summary.published_ham) -}}
                    </li>
                    <li>
                        {{- ngettext('%(num)s blocked spam change',
                                     '%(num)s blocked spam changes',
                                     summary.blocked_spam) }}
                        (<strong>
                            {{- _('%(rate)0.1f%% of all changes',
                                rate=(100 * summary.blocked_spam_rate)) -}}
                         </strong>)
                    </li>
                    <li>
                        {{- ngettext('%(num)s blocked ham change',
                                     '%(num)s blocked ham changes',
                                     summary.blocked_ham) }}
                        (<strong>
                            {{- _('%(rate)0.1f%% false positive rate',
                                rate=(100 * summary.blocked_ham_rate)) -}}
                         </strong>)
                    </li>
                    <li>
                        {{- ngettext('%(num)s published spam change',
                                     '%(num)s published spam changes',
                                     summary.published_spam) }}
                        (<strong>
                            {{- _('%(rate)0.1f%% false negative rate',
                                rate=(100 * summary.published_spam_rate)) -}}
                         </strong>)
                    </li>
                </ul>
            </p>
          {% else %}
            <p>
                {{ ngettext('There were no edits yesterday.',
                            'There were no edits in the past %(num)s days.',
                            summary.days) }}
            </p>
          {% endif %}
        <h2>{{ _('Trends') }}</h2>
        <h3>{{ _('Over Time') }}</h3>
            <table>
                <thead>
                    <tr>
                        <th rowspan=2 class="col-period head-period">{{ _('Period') }}</th>
                        <th colspan=9 class="col-group-this-period">{{ _('This Period') }}</th>
                        <th colspan=9 class="col-group-last-period">{{ _('Last Period') }}</th>
                    </tr>
                    <tr>
                        {% for group in ('current', 'previous') -%}
                        <th class="col-start">{{ _('Start') }}</th>
                        <th class="col-end">{{ _('End') }}</th>
                        <th class="col-total">{{ _('Total Edits') }}</th>
                        <th colspan=2 class="col-blocked-spam">{{ _('Blocked Spam') }}</th>
                        <th colspan=2 class="col-published-spam">{{ _('Published Spam') }}</th>
                        <th colspan=2 class="col-blocked-ham">{{ _('Blocked Ham') }}</th>
                        {%- endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in trends.over_time -%}
                    <tr>
                        <th scope="row" class="col-period">{{ names[row.id] | default(row.id) }}</th>
                        {% for group in ('current', 'previous') %}
                        <td class="date col-start">{{ row[group].start }}</td>
                        <td class="date col-end">{{ row[group].end }}</td>
                        <td class="data col-total">{{ row[group].total }}</td>
                        <td class="data col-blocked-spam">{{ row[group].blocked_spam }}</td>
                        <td class="rate col-blocked-spam">{{ '%0.1f%%' | format(100 * row[group].blocked_spam_rate) }} </td>
                        <td class="data col-published-spam">{{ row[group].published_spam }}</td>
                        <td class="rate col-published-spam">{{ '%0.1f%%' | format(100 * row[group].published_spam_rate) }}</td>
                        <td class="data col-blocked-ham">{{ row[group].blocked_ham }}</td>
                        <td class="rate col-blocked-ham">{{ '%0.1f%%' | format(100 * row[group].blocked_ham_rate) }}</td>
                        {%- endfor %}
                    </tr>
                    {%- endfor %}
                </tbody>
            </table>
        <h3>{{ _('By User Groups and Change Types') }}</h3>
            <table>
                <thead>
                    <tr>
                        <th class="col-edit-group head-group">{{ _('User Group') }}</th>
                        <th class="col-edit-type head-change-type">{{ _('Edit Type') }}</th>
                        <th class="col-total">{{ _('Total Edits') }}</th>
                        <th colspan=2 class="col-blocked-spam">{{ _('Blocked Spam') }}</th>
                        <th colspan=2 class="col-published-spam">{{ _('Published Spam') }}</th>
                        <th colspan=2 class="col-blocked-ham">{{ _('Blocked Ham') }}</th>
                    </tr>
                </thead>
                <tbody>
                  {% for group_id in categories.group -%}
                    {% for change_type in change_types -%}
                        {% set page_id = change_type.fresh + '_' + change_type.lang -%}
                        {% set blocked_spam = summary[group_id + '_blocked_spam_' + page_id] -%}
                        {% set published_spam = summary[group_id + '_published_spam_' + page_id] -%}
                        {% set blocked_ham = summary[group_id + '_blocked_ham_' + page_id] -%}
                        {% set published_ham = summary[group_id + '_published_ham_' + page_id] -%}
                        {% set total = blocked_spam + published_spam + blocked_ham + published_ham -%}
                        {% if total -%}
                          {% set blocked_spam_rate = blocked_spam / total -%}
                          {% set blocked_ham_rate = blocked_ham / total -%}
                          {% set published_spam_rate = published_spam / total -%}
                        {% else -%}
                          {% set blocked_spam_rate = 0 -%}
                          {% set blocked_ham_rate = 0 -%}
                          {% set published_spam_rate = 0 -%}
                        {% endif -%}
                    <tr>
                        {% if loop.first -%}
                        <th scope="row" rowspan={{change_types | length}} class="col-edit-group">{{ names['group_' + group_id] | default(group_id) }}</th>
                        {% endif -%}
                        <th scope="row" class="col-change-type">{{ names[change_type.id] | default(change_type.id) }}</th>
                        <td class="data col-total">{{ total }}</td>
                        <td class="data col-blocked-spam">{{ blocked_spam }}</td>
                        <td class="rate col-blocked-spam">{{ '%0.1f%%' | format(100 * blocked_spam_rate) }} </td>
                        <td class="data col-published-spam">{{ published_spam }}</td>
                        <td class="rate col-published-spam">{{ '%0.1f%%' | format(100 * published_spam_rate) }} </td>
                        <td class="data col-blocked-ham">{{ blocked_ham }}</td>
                        <td class="rate col-blocked-ham">{{ '%0.1f%%' | format(100 * blocked_ham_rate) }} </td>
                    </tr>
                    {%- endfor %}
                  {%- endfor %}
                </tbody>
            </table>
        <h2>{{ _('Recent Events') }}</h2>
        <h3>{{ _('Published Spam') }}</h3>
          {% if recent_spam %}
            <table>
                <thead>
                    <tr>
                        <th>{{ _('Date') }}</th>
                        <th>{{ _('Time Active (seconds)') }}</th>
                        <th>{{ _('Revision') }}</th>
                        <th>{{ _('Change Type') }}</th>
                        <th>{{ _('Moderator') }}</th>
                        <th>{{ _('Path') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rs in recent_spam -%}
                    <tr>
                        <td>{{ rs.date }}</td>
                        <td>{{ rs.time_active }}</td>
                        <td><a href="{{ rs.revision_path }}">{{ rs.revision_id }}</a></td>
                        <td>{{ names[rs.change_type] | default(rs.change_type) }}</td>
                        <td>{{ rs.moderator }}</td>
                        <td><a href="{{ rs.document_path }}">{{ rs.document_path }}</a></td>
                    </tr>
                    {% endfor -%}
                </tbody>
            </table>
          {% else %}
            <p>{{ _('No recent published spam.') }}</p>
          {% endif %}

        <h3>{{ _('Blocked Edits') }}</h3>
          {% if recent_blocked %}
            <table>
                <thead>
                    <tr>
                        <th>{{ _('Date') }}</th>
                        <th>{{ _('Change Type') }}</th>
                        <th>{{ _('Moderator') }}</th>
                        <th>{{ _('Review') }}</th>
                        <th>{{ _('Path') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rb in recent_blocked -%}
                    <tr>
                        <td>{{ rb.date }}</td>
                        <td>{{ names[rb.change_type] | default(rb.change_type) }}</td>
                        <td>{{ rb.moderator }}</td>
                        <td><a href="{{ rb.admin_url }}">{{ rb.review }}</a></td>
                        <td>
                            {%- if rb.has_link -%}
                                <a href="{{ rb.document_path }}">{{ rb.document_path }}</a>
                            {%- else -%}
                                {{ rb.document_path }}
                            {%- endif -%}
                        </td>
                    </tr>
                    {% endfor -%}
                </tbody>
            </table>
          {% else %}
            <p>{{ _('No recent blocked edits.') }}</p>
          {% endif %}

        <div style="display:none">
        <h2>Raw</h2>
            <table>
                <thead>
                    <tr>
                        {% for column_id in raw.columns %}
                        <th class="col-{{ column | replace('_', '-') }}">{{ names[column_id] | default(column_id) }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for data_row in raw.data %}
                    <tr>
                        {% for item in data_row %}
                        <td><code>{{ item }}</code></td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <ul>
        <li>{{ _('Historical data generated at %(date)s', date=generated) }}</li>
        <li>{{ _('Recent event data generated at %(date)s', date=now) }}</li>
    </ul>
{% endblock %}
